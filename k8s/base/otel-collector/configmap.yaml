apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
  labels:
    app: otel-collector
data:
  otel-collector-config.yaml: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      # File log receiver for Claude and AI job logs
      filelog:
        include:
          - /var/log/claude/*.jsonl
          - /var/log/claude/events.jsonl
          - /var/log/ai-jobs/**/*.jsonl
          - /var/log/ai-jobs/**/*.log
        start_at: end
        operators:
          - type: json_parser
            timestamp:
              parse_from: attributes.timestamp
              layout: '%Y-%m-%dT%H:%M:%SZ'

      filelog/k8slogs:
        include:
          - /var/log/pods/monitoring_*/*/*.log
        exclude:
          - /var/log/pods/monitoring_otel-collector-*/*/*.log
        start_at: end
        include_file_path: true
        include_file_name: false
        operators:
          - type: container
            id: container-parser

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024

      # Add resource attributes
      resource:
        attributes:
          - key: service.name
            value: claude-code
            action: upsert
          - key: deployment.environment
            value: local
            action: upsert

    exporters:
      # Forward OTLP telemetry to Cribl Stream Standalone via gRPC.
      # Cribl Stream Standalone OTLP source: open_telemetry type, protocol: grpc, port 4317, 0.0.0.0
      otlp:
        endpoint: cribl-stream-standalone:4317
        tls:
          insecure: true

      # Debug logging
      debug:
        verbosity: normal
        sampling_initial: 5
        sampling_thereafter: 200

    service:
      extensions: [health_check]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch, resource]
          exporters: [otlp, debug]
        metrics:
          receivers: [otlp]
          processors: [batch, resource]
          exporters: [otlp, debug]
        logs:
          receivers: [otlp, filelog, filelog/k8slogs]
          processors: [batch, resource]
          exporters: [otlp, debug]
