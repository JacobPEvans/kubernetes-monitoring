apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
  labels:
    app: otel-collector
data:
  otel-collector-config.yaml: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      # File log receiver for Claude and AI job logs
      filelog:
        include:
          - /var/log/claude/*.jsonl
          - /var/log/claude/events.jsonl
          - /var/log/ai-jobs/**/*.jsonl
          - /var/log/ai-jobs/**/*.log
        start_at: end
        operators:
          - type: json_parser
            timestamp:
              parse_from: attributes.timestamp
              layout: '%Y-%m-%dT%H:%M:%SZ'

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024

      # Add resource attributes
      resource:
        attributes:
          - key: service.name
            value: claude-code
            action: upsert
          - key: deployment.environment
            value: local
            action: upsert

    exporters:
      # Forward OTLP telemetry to Cribl Edge (managed by Cribl Cloud).
      # Requires OTLP source configured in Cribl Cloud fleet UI.
      # Future: redirect to cribl-stream-managed once Stream is cloud-managed.
      otlphttp:
        endpoint: http://cribl-edge-managed:9420

      # Debug logging
      debug:
        verbosity: normal
        sampling_initial: 5
        sampling_thereafter: 200

    service:
      extensions: [health_check]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch, resource]
          exporters: [otlphttp, debug]
        metrics:
          receivers: [otlp]
          processors: [batch, resource]
          exporters: [otlphttp, debug]
        logs:
          receivers: [otlp, filelog]
          processors: [batch, resource]
          exporters: [otlphttp, debug]
