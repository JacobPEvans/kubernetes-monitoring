apiVersion: v1
kind: ConfigMap
metadata:
  name: cribl-edge-standalone-config
  namespace: monitoring
data:
  setup-edge.sh: |
    #!/bin/sh
    # Configure Cribl Edge: install pack.
    # Output and input config handled by CRIBL_BEFORE_START_CMD env vars.
    # Runs as postStart lifecycle hook on every pod start.
    RETRIES=0
    MAX_RETRIES=90
    AUTH=""

    # Phase 1: Wait for auth API
    while [ $RETRIES -lt $MAX_RETRIES ]; do
      AUTH=$(curl -sf -X POST http://127.0.0.1:9420/api/v1/auth/login \
        -H 'Content-Type: application/json' \
        -d '{"username":"admin","password":"'"${CRIBL_EDGE_PASSWORD:-admin}"'"}' 2>/dev/null | \
        sed 's/.*"token":"\([^"]*\)".*/\1/')
      if [ -n "$AUTH" ]; then
        break
      fi
      RETRIES=$((RETRIES + 1))
      sleep 2
    done

    if [ -z "$AUTH" ]; then
      echo "ERROR: Cribl auth API not ready after ${MAX_RETRIES} retries"
      exit 1
    fi
    echo "Auth ready after $RETRIES retries"

    # Phase 2: Wait for worker to be ready (inputs endpoint available)
    RETRIES=0
    while [ $RETRIES -lt 30 ]; do
      WORKER_CHECK=$(curl -sf "http://127.0.0.1:9420/api/v1/system/inputs" \
        -H "Authorization: Bearer $AUTH" 2>/dev/null || true)
      if echo "$WORKER_CHECK" | grep -q '"count"'; then
        break
      fi
      RETRIES=$((RETRIES + 1))
      sleep 2
    done
    echo "Worker ready after $RETRIES additional retries"

    # Phase 3: Install pack if not already installed
    PACK_CHECK=$(curl -sf "http://127.0.0.1:9420/api/v1/packs/cc-edge-claude-code" \
      -H "Authorization: Bearer $AUTH" 2>/dev/null || true)

    if echo "$PACK_CHECK" | grep -q "cc-edge-claude-code"; then
      echo "Pack already installed"
    else
      mkdir -p "${CRIBL_VOLUME_DIR:-/opt/cribl}/state/packs"
      cp /packs/cc-edge-claude-code.crbl "${CRIBL_VOLUME_DIR:-/opt/cribl}/state/packs/"
      RESULT=$(curl -sf -X POST http://127.0.0.1:9420/api/v1/packs \
        -H "Authorization: Bearer $AUTH" \
        -H 'Content-Type: application/json' \
        -d '{"source":"cc-edge-claude-code.crbl"}' 2>&1)
      echo "Pack install result: $RESULT"

      # Phase 4: Commit and restart to apply pack installation
      curl -sf -X POST "http://127.0.0.1:9420/api/v1/version/commit" \
        -H "Authorization: Bearer $AUTH" \
        -H 'Content-Type: application/json' \
        -d '{"message":"Install cc-edge-claude-code pack"}' 2>&1
      echo "Config committed"

      curl -sf -X POST "http://127.0.0.1:9420/api/v1/system/settings/restart" \
        -H "Authorization: Bearer $AUTH" 2>&1
      echo "Worker restart triggered"
    fi
  outputs.yml: |
    outputs:
      stream-hec:
        type: splunk_hec
        url: "http://cribl-stream-standalone:8088/services/collector"
        token: "edge-internal"
        index: "claude"
        source: "cribl-edge-standalone"
        sourcetype: "claude:code:session"
        rejectUnauthorized: false
        compress: false
        concurrency: 5
        maxPayloadSizeKB: 4096
        onBackpressure: block
        pqEnabled: true
        pqMaxSize: "5GB"
        pqPath: /opt/cribl/data/pq
      default:
        type: default
        defaultId: stream-hec
  inputs-override.yml: |
    inputs:
      claude-code-logs:
        disabled: false
        sendToRoutes: true
        type: file
        mode: manual
        interval: 10
        recurse: true
        path: "__CLAUDE_HOME__/.claude/projects/"
        filenames:
          - "*.jsonl"
        metadata:
          - name: datatype
            value: "'claude-code'"
